<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>家庭物料管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --blue:#2f80ed;
    --blue-dark:#1b4f9d;
    --blue-light:#e3f2ff;
    --border:#c8dcff;
    --fg:#1f2933;
    --muted:#6b7280;
    --chip:#f4f7ff;
    --radius:16px;
    --danger:#ef4444;
    --warn:#f97316;
    --success:#16a34a;
    --bg-soft:#f3f7ff;
  }

  *{box-sizing:border-box}

  body{
    font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    color:var(--fg);
    margin:0;
    background:
      radial-gradient(circle at 0 0,rgba(47,128,237,.18),transparent 55%),
      radial-gradient(circle at 100% 100%,rgba(37,99,235,.16),transparent 55%),
      linear-gradient(135deg,#e6f3ff 0%,#f7fbff 45%,#e3f2ff 100%);
    background-attachment:fixed;
  }

  main{
    padding:24px;
    margin-top:84px;
    max-width:1200px;
    margin-left:auto;
    margin-right:auto;
  }

  .topbar{
    position:sticky; top:0; z-index:50;
    width:100%;
    background:linear-gradient(90deg,#0d254f 0%, #1c64d7 100%);
    color:#fff;
    box-shadow:0 2px 12px rgba(15,23,42,.18);
    transition:all .25s ease;
  }
  .topbar-inner{
    max-width:1200px; margin:0 auto;
    display:flex; align-items:center; justify-content:space-between;
    height:84px; padding:0 24px;
    transition:height .25s ease, padding .25s ease;
  }
  .title{
    font-weight:800; font-size:24px; letter-spacing:2px;
    transition:all .25s ease; white-space:nowrap;
  }
  .topbar.shrink .topbar-inner{ height:54px; padding:0 16px; }
  .topbar.shrink .title{ font-weight:700; font-size:18px; letter-spacing:1px; }

  .hamburger{
    width:40px; height:40px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.6);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    margin-right:12px;
    background:rgba(255,255,255,.12);
  }
  .hamburger span{
    display:block; width:18px; height:2px; background:#fff;
    position:relative;
  }
  .hamburger span::before,
  .hamburger span::after{
    content:""; position:absolute; left:0; width:18px; height:2px; background:#fff;
  }
  .hamburger span::before{ top:-6px;}
  .hamburger span::after{ top:6px;}

  .user-info{ font-size:13px; opacity:.95; }

  .menu-drawer{
    max-width:1200px; margin:0 auto;
    background:rgba(255,255,255,.98);
    color:var(--fg);
    box-shadow:0 14px 30px rgba(15,23,42,.16);
    border-radius:0 0 18px 18px;
    padding:16px 24px 20px;
    display:none;
    grid-template-columns:1.1fr 1fr;
    gap:24px;
    border-inline:1px solid rgba(180,198,255,.8);
    border-bottom:1px solid rgba(180,198,255,.8);
  }
  .menu-drawer.open{ display:grid; }

  .menu-section-title{ font-size:13px; font-weight:600; color:var(--muted); margin-bottom:6px; }
  .chip-list{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip-link{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f7f9ff;
    font-size:12px;
    text-decoration:none;
    color:var(--fg);
    cursor:pointer;
  }
  .chip-link:hover{
    border-color:var(--blue);
    color:var(--blue);
    background:#e5f0ff;
  }

  input, select, button, textarea{ font-family:inherit; }
  input, select, button{
    height:44px;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    background:var(--chip);
    outline:none;
  }
  input:focus, select:focus, textarea:focus{
    background:#fff;
    border-color:#93b8ff;
    box-shadow:0 0 0 3px rgba(37,99,235,.18);
  }
  select{ -webkit-appearance:none; -moz-appearance:none; appearance:none; line-height:1.2; }

  .btn{
    cursor:pointer; border-radius:12px;
    display:inline-flex; align-items:center; justify-content:center;
    gap:4px; font-size:14px;
  }
  .btn-primary{
    background:linear-gradient(135deg,#2f80ed,#2563eb);
    color:#fff; border-color:transparent;
  }
  .btn-primary:hover{ filter:brightness(1.05); }
  .btn-ghost{
    background:#fff;
    border:1px solid #2f80ed;
    color:#1b4f9d;
  }
  .btn-ghost:hover{ background:#e7f1ff; }
  .btn-sm{ height:32px; padding:4px 10px; border-radius:999px; font-size:12px; }

  .hero{ display:flex; flex-direction:column; gap:18px; margin-bottom:20px; }
  .hero-title{
    font-size:28px; font-weight:800; letter-spacing:1px;
    display:flex; align-items:flex-end; gap:10px;
    color:#143f7a;
  }
  .hero-sub{ font-size:14px; color:var(--muted); }
  .action-grid{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:14px; }
  .action-card{
    background:linear-gradient(135deg,rgba(255,255,255,.96),rgba(230,242,255,.96));
    border-radius:18px;
    padding:14px 14px 16px;
    border:1px solid rgba(184,204,255,.9);
    text-decoration:none;
    color:var(--fg);
    display:flex; flex-direction:column; justify-content:space-between;
    box-shadow:0 6px 16px rgba(15,23,42,.10);
    backdrop-filter:blur(10px);
    transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease;
  }
  .action-card:hover{
    transform:translateY(-3px);
    box-shadow:0 12px 26px rgba(15,23,42,.18);
    border-color:#2f80ed;
  }
  .action-card-title{ font-weight:700; margin-bottom:4px; }
  .action-card-desc{ font-size:12px; color:var(--muted); margin-bottom:8px; }
  .pill{
    font-size:11px;
    border-radius:999px;
    padding:3px 8px;
    background:#e3efff;
    color:#1b4f9d;
    display:inline-flex; align-items:center; gap:4px;
    align-self:flex-start;
  }

  .middle-grid{
    display:grid; grid-template-columns:2fr 1.3fr;
    gap:20px; margin-top:16px; margin-bottom:26px;
  }
  .panel{
    background:rgba(255,255,255,.96);
    border-radius:20px;
    padding:16px 18px 18px;
    border:1px solid rgba(184,204,255,.9);
    box-shadow:0 4px 14px rgba(15,23,42,.12);
    backdrop-filter:blur(6px);
  }
  .panel-header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:10px;
  }
  .panel-title{ font-size:15px; font-weight:700; color:#123763; }
  .panel-sub{ font-size:12px; color:var(--muted); }

  .note-input-row{ display:flex; gap:8px; margin-bottom:12px; }
  .note-input-row input{ flex:1; }
  .note-list{
    list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px;
    max-height:200px; overflow:auto;
  }
  .note-item{
    display:flex; align-items:center; gap:8px;
    font-size:13px; padding:6px 8px;
    border-radius:10px;
    background:#f4f7ff;
  }
  .note-text{ flex:1; }
  .note-time{ font-size:11px; color:var(--muted); }
  form.inline{ display:inline; }

  .calendar-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
  .calendar-title{ font-size:14px; font-weight:600; color:#123763; }
  .calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:11px; margin-top:4px; }
  .calendar-cell{ text-align:center; padding:6px 0; border-radius:8px; }
  .cal-weekday{ font-weight:600; color:var(--muted); }
  .cal-day{ background:#f7f9ff; }
  .cal-day.today{ background:#d7e8ff; font-weight:700; color:#1b4f9d; }

  .section{
    margin-top:28px;
    background:linear-gradient(145deg,rgba(255,255,255,.98),rgba(226,239,255,.96));
    border-radius:22px;
    padding:18px 20px 22px;
    border:1px solid rgba(184,204,255,.9);
    box-shadow:0 4px 16px rgba(15,23,42,.12);
    backdrop-filter:blur(8px);
  }
  .section-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .section-title{ font-size:18px; font-weight:700; color:#123763; }
  .section-sub{ font-size:12px; color:var(--muted); }

  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
  .row>.field{ display:flex; flex-direction:column; min-width:180px; flex:1 1 220px; }
  .field--actions{ align-self:flex-end; display:flex; gap:8px; flex-wrap:wrap; }

  label{ font-size:12px; color:var(--muted); margin:2px 0 6px; }
  .form-help{ margin-top:6px; color:var(--muted); font-size:12px; }

  .ai-input-wrap{ display:flex; gap:6px; align-items:center; }
  .ai-input-wrap input{ flex:1; }
  .btn-ai{ white-space:nowrap; }

  table{border-collapse:collapse; width:100%; margin-top:10px;}
  th,td{
    border:1px solid var(--border);
    padding:8px;
    vertical-align:top;
    font-size:13px;
    background:#ffffff;
  }
  th{ background:var(--blue-light); text-align:left; }

  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
    margin-top:2px;
  }
  .badge-low{ background:#fee2e2; color:var(--danger); }
  .badge-exp7{ background:#fef3c7; color:var(--warn); }
  .badge-exp14{ background:#fffbeb; color:#92400e; }

  tr.low-stock-row{ background:#fff5f5; }

  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(15,23,42,.45);
    display:none; align-items:center; justify-content:center;
    z-index:80;
  }
  .modal-backdrop.show{ display:flex; }
  .modal{
    background:#ffffff;
    border-radius:18px;
    padding:18px 18px 16px;
    width:260px;
    box-shadow:0 20px 40px rgba(15,23,42,.45);
  }
  .modal h3{ margin:0 0 8px; font-size:16px; color:#123763; }
  .modal p{ margin:0 0 10px; font-size:13px; color:var(--muted); }
  .modal input{ width:100%; margin-bottom:12px; }
  .modal-actions{ display:flex; justify-content:flex-end; gap:8px; }

  .toast{
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:#16a34a;
    color:#fff; padding:10px 16px;
    border-radius:999px;
    font-size:13px;
    box-shadow:0 8px 20px rgba(22,163,74,.5);
    z-index:90;
    opacity:0; pointer-events:none;
    animation:toast-in 2.2s ease forwards;
  }
  @keyframes toast-in{
    0%{ opacity:0; transform:translate(-50%,-60%); }
    10%,80%{ opacity:1; transform:translate(-50%,-50%); }
    100%{ opacity:0; transform:translate(-50%,-52%); }
  }

  @media (max-width:900px){
    .action-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .middle-grid{ grid-template-columns:1fr; }
  }
  @media (max-width:640px){
    main{ padding:16px; margin-top:72px; }
    .topbar-inner{ height:72px; }
    .hero-title{ font-size:22px; flex-direction:column; align-items:flex-start; }
    .row>.field{ min-width:48%; }
    table{ font-size:12px; }
    th,td{ padding:6px; }
  }
</style>

</head>
<body>
  <header class="topbar" id="topbar">
    <div class="topbar-inner">
      <div style="display:flex; align-items:center; gap:8px;">
        <div class="hamburger" id="btnMenu"><span></span></div>
        <div class="title">家庭物料管理系統</div>
      </div>

      <div class="user-info">
        <span th:if="${session.loginUser != null}">
          歡迎，
          <span th:text="${session.loginUser.displayName != null} ? ${session.loginUser.displayName} : ${session.loginUser.username}">
            使用者
          </span>
        </span>

        <form th:if="${session.loginUser != null}"
              th:action="@{/logout}" method="post"
              style="display:inline; margin-left:8px;">
          <button type="submit"
                  style="background:transparent;border:1px solid #e5e7eb;color:#e5e7eb;
                        border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer;">
            登出
          </button>
        </form>

        <a th:if="${session.loginUser == null}"
           th:href="@{/login}"
           style="color:#e5e7eb; text-decoration:none; font-size:13px;">
          登入
        </a>
      </div>
    </div>

    <div class="menu-drawer" id="menuDrawer">
      <div>
        <div class="menu-section-title">依地點瀏覽</div>
        <div class="chip-list">
          <a class="chip-link" th:each="loc : ${locations}"
             th:href="@{/items/location(name=${loc})}"
             th:text="${loc}">客廳</a>
        </div>
      </div>
      <div>
        <div class="menu-section-title">依物品類別瀏覽</div>
        <div class="chip-list">
          <a class="chip-link" th:each="cat : ${categories}"
             th:href="@{/items/category(name=${cat})}"
             th:text="${cat}">食材</a>
        </div>
      </div>
    </div>
  </header>

  <!-- 原本新增成功的 toast（保留） -->
  <div class="toast"
       th:if="${successMessage != null and !#strings.isEmpty(successMessage)}"
       th:text="${successMessage}">
    新增成功！
  </div>

  <main>
    <section class="hero">
      <div class="hero-title"><span>歡迎回來，開始整理你的家庭物資吧。</span></div>
      <p class="hero-sub">
        登入後首頁提供新增、查詢、即將過期與數量不足的快速入口；左上角三條線可依地點或物品類別快速跳轉。
      </p>

      <div class="action-grid">
        <a href="#section-create" class="action-card">
          <div>
            <div class="action-card-title">新增物品</div>
            <div class="action-card-desc">輸入名稱、房間、地點、數量與有效期限，快速建立庫存。</div>
          </div>
          <span class="pill">前往新增區塊</span>
        </a>
        <a href="#section-create" class="action-card">
          <div>
            <div class="action-card-title">查詢物品</div>
            <div class="action-card-desc">可依名稱、SKU、房間、地點或類別查詢目前的存量。</div>
          </div>
          <span class="pill">支援房間查詢</span>
        </a>
        <a href="#section-expire" class="action-card">
          <div>
            <div class="action-card-title">過期查詢</div>
            <div class="action-card-desc">查看已過期與 7 / 14 天內即將到期的物品。</div>
          </div>
          <span class="pill">到期提醒</span>
        </a>
        <a href="#section-low" class="action-card">
          <div>
            <div class="action-card-title">數量不足</div>
            <div class="action-card-desc">檢視庫存過少的物品，避免臨時缺貨。</div>
          </div>
          <span class="pill">低庫存提醒</span>
        </a>
      </div>
    </section>

    <section class="middle-grid">
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">留言 / 交代事項</div>
            <div class="panel-sub">首頁僅顯示未完成事項，完成可勾選。總攬頁面會顯示全部（含已完成）。</div>
          </div>
          <a class="btn btn-ghost btn-sm" th:href="@{/notes}">查看全部事項總覽</a>
        </div>

        <form th:action="@{/notes}" method="post" class="note-input-row">
          <input name="text" placeholder="輸入要交代的事情，例如：週五前確認冰箱雞蛋數量" required />
          <button type="submit" class="btn btn-primary">新增</button>
        </form>

        <ul class="note-list">
          <li class="note-item" th:each="note : ${openNotes}">
            <form class="inline" th:action="@{|/notes/${note.id}/toggle|}" method="post">
              <input type="checkbox" onchange="this.form.submit()" />
            </form>

            <div class="note-text" th:text="${note.text}">把客廳零食區重新整理</div>

            <!-- ✅ createdAt null-safe -->
            <div class="note-time" th:if="${note.createdAt != null}"
                 th:text="${#temporals.format(note.createdAt,'MM/dd HH:mm')}">11/17 21:05</div>
            <div class="note-time" th:if="${note.createdAt == null}">--</div>
          </li>
        </ul>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">家庭行事曆</div>
        </div>
        <div class="calendar-header">
          <button type="button" class="btn btn-ghost btn-sm" id="calPrev">&lt;</button>
          <div class="calendar-title" id="calTitle">2025 / 11</div>
          <button type="button" class="btn btn-ghost btn-sm" id="calNext">&gt;</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </section>

    <section class="section" id="section-create">
      <div class="section-header">
        <div>
          <div class="section-title">新增 / 查詢物品</div>
          <div class="section-sub">查詢時以「名稱」為必填，其餘選填；新增時請填寫儲位與數量，過期日期可選填。</div>
        </div>
      </div>

      <form th:object="${item}" id="createSearchForm" method="post" th:action="@{/items}">
        <div class="row">
          <div class="field">
            <label>名稱（查詢時必填）</label>
            <div class="ai-input-wrap">
              <input th:field="*{name}" id="nameField" placeholder="螺絲 M3 / 牛奶 / 洗衣精"/>
              <button type="button" class="btn btn-ghost btn-sm btn-ai" id="btnAiSuggest">自動填寫</button>
            </div>
          </div>

          <div class="field">
            <label>SKU</label>
            <input th:field="*{sku}" id="skuField" placeholder="唯一代碼（選填）"/>
          </div>

          <div class="field">
  <label>物品類別</label>

  <select id="categorySelect-create">
    <option value="" selected>選擇類別（選填）</option>
    <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}">食材</option>
    <option value="__NEW__">＋新增類別…</option>
  </select>

  <input id="categoryInput-create" type="text" placeholder="輸入新類別" style="display:none;" />

  <input type="hidden" th:field="*{category}" id="categoryField-create"/>
</div>


          <div class="field">
            <label>房間</label>
            <select th:field="*{room}">
              <option value="">選擇房間（查詢可用）</option>
              <option th:each="room : ${rooms}" th:value="${room}" th:text="${room}">客廳</option>
            </select>
          </div>

          <div class="field">
            <label>單位</label>
            <input th:field="*{unit}" placeholder="pcs/box/kg（選填）"/>
          </div>

          <div class="field" style="max-width:220px">
            <label>數量（新增用）</label>
            <input type="number" th:field="*{quantity}" min="0" value="0"/>
          </div>

          <div class="field">
            <label>儲位</label>
            <select id="locationSelect-create">
              <option value="" selected>選擇地點（選填或新增時必填）</option>
              <option th:each="loc : ${locations}" th:value="${loc}" th:text="${loc}">A1-3</option>
              <option value="__NEW__">＋新增地點…</option>
            </select>
            <input id="locationInput-create" type="text" placeholder="輸入新地點" style="display:none;"/>
            <input type="hidden" th:field="*{location}" id="locationField-create"/>
          </div>

          <div class="field">
            <label>有效期限（選填）</label>
            <input type="date" th:field="*{expireDate}"/>
          </div>

          <div class="field--actions">
            <button type="submit" class="btn btn-primary" id="btnCreate">新增</button>
            <button class="btn btn-ghost" id="btnSearch" formaction="/items/search" formmethod="get">查詢</button>
          </div>
        </div>

        <div class="form-help">
          新增時請選擇或輸入儲位；查詢時僅「名稱」必填，其餘欄位可協助縮小範圍。
        </div>
      </form>
    </section>

    <section class="section" id="section-list">
      <div class="section-header">
        <div>
          <div class="section-title">物料清單</div>
          <div class="section-sub">此清單顯示目前條件下的物品；每一列支援 +1 / -1、刪除與大量修改數量。</div>
        </div>
      </div>

      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>名稱 / 類別</th>
          <th>SKU</th>
          <th>房間 / 儲位</th>
          <th>單位 / 數量</th>
          <th>有效期限</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <!-- ✅ 不再用 it.lowStock / it.daysToExpire（避免 getter 炸掉） -->
        <tr th:each="it : ${items}"
            th:classappend="${it.quantity != null and it.quantity <= 0} ? 'low-stock-row' : ''">
          <td th:text="${it.id}">1</td>

          <td>
            <div th:text="${it.name}">螺絲</div>
            <div style="font-size:11px; color:var(--muted);"
                 th:text="${it.category != null and !#strings.isEmpty(it.category) ? it.category : '-'}">五金</div>
          </td>

          <td th:text="${it.sku != null and !#strings.isEmpty(it.sku) ? it.sku : '-'}">SCREW-M3</td>

          <td>
            <div style="font-size:11px; color:var(--muted);">
              房間：<span th:text="${it.room != null and !#strings.isEmpty(it.room) ? it.room : '-'}">客廳</span>
            </div>
            <div>儲位：<strong th:text="${it.location != null and !#strings.isEmpty(it.location) ? it.location : 'UNASSIGNED'}">A1-3</strong></div>
          </td>

          <td>
            <div>
              <span th:text="${it.unit != null and !#strings.isEmpty(it.unit) ? it.unit : '-'}">pcs</span>
              ×
              <span th:text="${it.quantity != null ? it.quantity : 0}">100</span>
            </div>
            <div th:if="${it.quantity != null and it.quantity <= 0}" class="badge badge-low">數量不足</div>
          </td>

          <!-- ✅ 不呼叫 it.daysToExpire，直接用 ChronoUnit 在模板算 -->
          <td th:with="d=${it.expireDate != null ? T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), it.expireDate) : null}">
            <div th:if="${it.expireDate != null}"
                 th:text="${#temporals.format(it.expireDate,'yyyy/MM/dd')}">2025/12/31</div>
            <div th:if="${it.expireDate == null}" style="color: var(--muted);">-</div>

            <div th:if="${d != null}">
              <span class="badge badge-exp7"  th:if="${d <= 7 and d >= 0}">7 天內到期</span>
              <span class="badge badge-exp14" th:if="${d <= 14 and d > 7}">14 天內到期</span>
            </div>
          </td>

          <td>
            <form class="inline" th:action="@{|/items/${it.id}/adjust|}" method="post">
              <input type="hidden" name="delta" value="1">
              <button type="submit" class="btn btn-ghost btn-sm">+1</button>
            </form>
            <form class="inline" th:action="@{|/items/${it.id}/adjust|}" method="post">
              <input type="hidden" name="delta" value="-1">
              <button type="submit" class="btn btn-ghost btn-sm">-1</button>
            </form>

            <button type="button"
                    class="btn btn-ghost btn-sm btn-editQty"
                    th:attr="data-id=${it.id},data-current=${it.quantity != null ? it.quantity : 0}">
              更改數量
            </button>

            <form class="inline" th:action="@{|/items/${it.id}/delete|}" method="post"
                  onsubmit="return confirm('確定刪除？')">
              <button type="submit" class="btn btn-ghost btn-sm">刪除</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </section>

    <section class="section" id="section-expire">
      <div class="section-header">
        <div>
          <div class="section-title">過期 / 即將到期物品</div>
          <div class="section-sub">分成「已過期」、「7 天內到期」、「14 天內到期」，方便你快速處理。</div>
        </div>
      </div>

      <div style="font-weight:700; color:#123763; margin:6px 0 6px;">已過期</div>
      <table th:if="${expiredItems != null and #lists.size(expiredItems) > 0}">
        <thead>
        <tr>
          <th>ID</th><th>名稱</th><th>類別</th><th>房間/儲位</th><th>數量</th><th>到期日</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="it : ${expiredItems}">
          <td th:text="${it.id}">1</td>
          <td th:text="${it.name}">牛奶</td>
          <td th:text="${it.category != null and !#strings.isEmpty(it.category) ? it.category : '-'}">食材</td>
          <td>
            房間：<span th:text="${it.room != null and !#strings.isEmpty(it.room) ? it.room : '-'}"></span>
            ／ 儲位：<strong th:text="${it.location != null and !#strings.isEmpty(it.location) ? it.location : 'UNASSIGNED'}"></strong>
          </td>
          <td>
            <span th:text="${it.unit != null and !#strings.isEmpty(it.unit) ? it.unit : '-'}"></span>
            ×
            <span th:text="${it.quantity != null ? it.quantity : 0}"></span>
          </td>
          <td>
            <div th:if="${it.expireDate != null}" th:text="${#temporals.format(it.expireDate,'yyyy/MM/dd')}"></div>
            <div th:if="${it.expireDate == null}" style="color:var(--muted);">-</div>
            <span class="badge badge-low">已過期</span>
          </td>
        </tr>
        </tbody>
      </table>
      <p th:if="${expiredItems == null or #lists.size(expiredItems) == 0}"
         style="font-size:13px;color:var(--muted);margin:0 0 12px;">
        目前沒有已過期物品 ✅
      </p>

      <div style="font-weight:700; color:#123763; margin:10px 0 6px;">7 天內到期</div>
      <table th:if="${exp7Items != null and #lists.size(exp7Items) > 0}">
        <thead>
        <tr>
          <th>ID</th><th>名稱</th><th>房間/儲位</th><th>數量</th><th>到期日</th><th>剩餘</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="it : ${exp7Items}"
            th:with="d=${it.expireDate != null ? T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), it.expireDate) : null}">
          <td th:text="${it.id}">1</td>
          <td>
            <div th:text="${it.name}"></div>
            <div style="font-size:11px; color:var(--muted);" th:text="${it.category != null and !#strings.isEmpty(it.category) ? it.category : '-'}"></div>
          </td>
          <td>
            房間：<span th:text="${it.room != null and !#strings.isEmpty(it.room) ? it.room : '-'}"></span>
            ／ 儲位：<strong th:text="${it.location != null and !#strings.isEmpty(it.location) ? it.location : 'UNASSIGNED'}"></strong>
          </td>
          <td>
            <span th:text="${it.unit != null and !#strings.isEmpty(it.unit) ? it.unit : '-'}"></span>
            ×
            <span th:text="${it.quantity != null ? it.quantity : 0}"></span>
          </td>
          <td>
            <div th:if="${it.expireDate != null}" th:text="${#temporals.format(it.expireDate,'yyyy/MM/dd')}"></div>
            <div th:if="${it.expireDate == null}" style="color:var(--muted);">-</div>
          </td>
          <td>
            <span class="badge badge-exp7" th:if="${d != null}" th:text="${d} + ' 天'">3 天</span>
            <span th:if="${d == null}" style="color:var(--muted);">-</span>
          </td>
        </tr>
        </tbody>
      </table>
      <p th:if="${exp7Items == null or #lists.size(exp7Items) == 0}"
         style="font-size:13px;color:var(--muted);margin:0 0 12px;">
        目前沒有 7 天內到期物品 ✅
      </p>

      <div style="font-weight:700; color:#123763; margin:10px 0 6px;">14 天內到期</div>
      <table th:if="${exp14Items != null and #lists.size(exp14Items) > 0}">
        <thead>
        <tr>
          <th>ID</th><th>名稱</th><th>房間/儲位</th><th>數量</th><th>到期日</th><th>剩餘</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="it : ${exp14Items}"
            th:with="d=${it.expireDate != null ? T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), it.expireDate) : null}">
          <td th:text="${it.id}">1</td>
          <td>
            <div th:text="${it.name}"></div>
            <div style="font-size:11px; color:var(--muted);" th:text="${it.category != null and !#strings.isEmpty(it.category) ? it.category : '-'}"></div>
          </td>
          <td>
            房間：<span th:text="${it.room != null and !#strings.isEmpty(it.room) ? it.room : '-'}"></span>
            ／ 儲位：<strong th:text="${it.location != null and !#strings.isEmpty(it.location) ? it.location : 'UNASSIGNED'}"></strong>
          </td>
          <td>
            <span th:text="${it.unit != null and !#strings.isEmpty(it.unit) ? it.unit : '-'}"></span>
            ×
            <span th:text="${it.quantity != null ? it.quantity : 0}"></span>
          </td>
          <td>
            <div th:if="${it.expireDate != null}" th:text="${#temporals.format(it.expireDate,'yyyy/MM/dd')}"></div>
            <div th:if="${it.expireDate == null}" style="color:var(--muted);">-</div>
          </td>
          <td>
            <span class="badge badge-exp14" th:if="${d != null}" th:text="${d} + ' 天'">10 天</span>
            <span th:if="${d == null}" style="color:var(--muted);">-</span>
          </td>
        </tr>
        </tbody>
      </table>
      <p th:if="${exp14Items == null or #lists.size(exp14Items) == 0}"
         style="font-size:13px;color:var(--muted);margin:0;">
        目前沒有 14 天內到期物品 ✅
      </p>
    </section>
  </main>

  <div class="modal-backdrop" id="qtyModalBg">
    <div class="modal">
      <h3>更改數量</h3>
      <p>請輸入新的數量，按「確認」後才會送出變更。</p>
      <input type="number" id="qtyInput" min="0" />
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost btn-sm" id="qtyCancel">取消</button>
        <button type="button" class="btn btn-primary btn-sm" id="qtyOk">確認</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="mergeModalBg" style="z-index: 9999;">
    <div class="modal" style="width: 320px;">
      <h3>⚠️ 發現重複物品</h3>
      <p>在庫存位置 <strong><span id="mergeTargetInfo"></span></strong> 已經有相同的物品了。</p>
      <p>請問您要將數量合併，還是建立一筆新的資料？</p>
      
      <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-primary btn-sm" id="btnConfirmMerge">合併數量</button>
        <button type="button" class="btn btn-ghost btn-sm" id="btnForceNew">建立新的一筆</button>
        <button type="button" class="btn btn-sm" style="border:none; color:#999;" id="btnCancelMerge">取消</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== 頂部縮小 ====== */
    const topbar = document.getElementById('topbar');
    const shrinkAt = 20;
    const onScroll = () => {
      if (window.scrollY > shrinkAt) topbar.classList.add('shrink');
      else topbar.classList.remove('shrink');
    };
    document.addEventListener('scroll', onScroll, {passive:true});
    onScroll();

    /* ====== 漢堡選單開關 ====== */
    const btnMenu = document.getElementById('btnMenu');
    const menuDrawer = document.getElementById('menuDrawer');
    btnMenu?.addEventListener('click', () => menuDrawer?.classList.toggle('open'));
    document.addEventListener('click',(e)=>{
      if(menuDrawer && btnMenu && !menuDrawer.contains(e.target) && !btnMenu.contains(e.target)){
        menuDrawer.classList.remove('open');
      }
    });

    /* ====== 儲位下拉／自訂 ====== */
    const selCreate = document.getElementById('locationSelect-create');
    const inputCreate = document.getElementById('locationInput-create');
    const fieldCreate = document.getElementById('locationField-create');

    function syncCreateLocation(){
      if (!selCreate) return;
      const v = selCreate.value;
      if (v === '__NEW__'){
        if (inputCreate) inputCreate.style.display='';
        if (fieldCreate) fieldCreate.value = (inputCreate?.value || '').trim();
      } else {
        if (inputCreate) inputCreate.style.display='none';
        if (fieldCreate) fieldCreate.value = v || '';
      }
    }
    if (selCreate){
      selCreate.addEventListener('change', syncCreateLocation);
      inputCreate?.addEventListener('input', () => {
        if (selCreate.value==='__NEW__' && fieldCreate) fieldCreate.value = (inputCreate.value || '').trim();
      });
    }

    /* ====== 新增／查詢 驗證 ====== */
    const formCS = document.getElementById('createSearchForm');
    const nameField = document.getElementById('nameField');
    const btnCreateEl = document.getElementById('btnCreate');
    const btnSearchEl = document.getElementById('btnSearch');
    
    /* ====== 類別下拉／自訂 ====== */
    const catSelect = document.getElementById('categorySelect-create'); // 注意：這邊您的原代碼可能有少 create 後綴，我幫您修正了
    const catInput  = document.getElementById('categoryInput-create');
    const catField  = document.getElementById('categoryField-create');

    function syncCategory(){
      if (!catSelect) return;
      const v = catSelect.value;
      if (v === '__NEW__') {
        catInput.style.display = '';
        catField.value = catInput.value.trim();
      } else {
        catInput.style.display = 'none';
        catField.value = v || '';
      }
    }

    if (catSelect){
      catSelect.addEventListener('change', syncCategory);
      catInput.addEventListener('input', ()=>{
        if (catSelect.value === '__NEW__') {
          catField.value = catInput.value.trim();
        }
      });
    }
/* ==========================================================
       ✅ 核心修改：新增按鈕邏輯 + 詢問視窗邏輯
       ========================================================== */
    const mergeModalBg = document.getElementById('mergeModalBg');
    const mergeTargetInfo = document.getElementById('mergeTargetInfo');
    const btnConfirmMerge = document.getElementById('btnConfirmMerge');
    const btnForceNew = document.getElementById('btnForceNew');
    const btnCancelMerge = document.getElementById('btnCancelMerge');
    
    // 動態抓取 hidden input
    let forceNewInput = document.getElementById('forceNewInput');

    // 監聽「新增」按鈕
    btnCreateEl?.addEventListener('click', async (e) => {
      
      // 1. 驗證邏輯
      syncCreateLocation();
      syncCategory();
      if (!fieldCreate?.value){
        e.preventDefault();
        alert('新增時請選擇或輸入儲位');
        return;
      }

      // 2. 攔截表單，不要馬上送出
      e.preventDefault();

      // 3. 準備參數
      const name = nameField.value;
      const room = document.querySelector('[name="room"]').value || '';
      const location = fieldCreate.value || '';
      
      // 👇 抓取日期 (關鍵修改)
      const expireDate = document.querySelector('[name="expireDate"]').value || ''; 
      
      // 如果沒填名字 (可能是查詢模式)，就直接送出給後端驗證
      if(!name) { 
         formCS.submit(); 
         return; 
      }

      try {
        // 4. 問後端：有沒有「同名、同地點、且同日期」的東西？
        const params = new URLSearchParams({ name, room, location, expireDate });
        const res = await fetch(`/api/items/check-exists?${params.toString()}`);
        const exists = await res.json(); 

        if (exists) {
          // 有重複 -> 跳出詢問視窗
          if (mergeTargetInfo) mergeTargetInfo.textContent = `${room ? room + ' - ' : ''}${location}`;
          mergeModalBg.classList.add('show');
        } else {
          // 沒重複 -> 直接送出 (forceNew = false)
          if (!forceNewInput) {
             forceNewInput = document.createElement('input');
             forceNewInput.type = 'hidden';
             forceNewInput.name = 'forceNew';
             forceNewInput.id = 'forceNewInput';
             formCS.appendChild(forceNewInput);
          }
          forceNewInput.value = 'false';
          formCS.submit();
        }
      } catch (err) {
        console.error('API Error:', err);
        // 如果 API 壞掉，為了不卡住使用者，直接送出
        formCS.submit(); 
      }
    });

    // === 詢問視窗的三個按鈕邏輯 ===
    
    // 1. 合併
    btnConfirmMerge?.addEventListener('click', () => {
       if (!forceNewInput) {
           forceNewInput = document.createElement('input');
           forceNewInput.type = 'hidden'; forceNewInput.name = 'forceNew'; forceNewInput.id = 'forceNewInput';
           formCS.appendChild(forceNewInput);
       }
       forceNewInput.value = 'false'; // 不強制新增 = 合併
       formCS.submit();
       mergeModalBg.classList.remove('show');
    });

    // 2. 建立新的一筆
    btnForceNew?.addEventListener('click', () => {
       if (!forceNewInput) {
           forceNewInput = document.createElement('input');
           forceNewInput.type = 'hidden'; forceNewInput.name = 'forceNew'; forceNewInput.id = 'forceNewInput';
           formCS.appendChild(forceNewInput);
       }
       forceNewInput.value = 'true'; // 強制新增！
       formCS.submit();
       mergeModalBg.classList.remove('show');
    });

    // 3. 取消
    btnCancelMerge?.addEventListener('click', () => {
       mergeModalBg.classList.remove('show');
    });
    // === 視窗按鈕事件 ===
    btnConfirmMerge?.addEventListener('click', () => {
       if (!forceNewInput) {
           forceNewInput = document.createElement('input');
           forceNewInput.type = 'hidden'; forceNewInput.name = 'forceNew'; forceNewInput.id = 'forceNewInput';
           formCS.appendChild(forceNewInput);
       }
       forceNewInput.value = 'false';
       formCS.submit();
       mergeModalBg.classList.remove('show');
    });

    btnForceNew?.addEventListener('click', () => {
       if (!forceNewInput) {
           forceNewInput = document.createElement('input');
           forceNewInput.type = 'hidden'; forceNewInput.name = 'forceNew'; forceNewInput.id = 'forceNewInput';
           formCS.appendChild(forceNewInput);
       }
       forceNewInput.value = 'true';
       formCS.submit();
       mergeModalBg.classList.remove('show');
    });

    btnCancelMerge?.addEventListener('click', () => {
       mergeModalBg.classList.remove('show');
    });

    /* ====== 查詢按鈕 (不變) ====== */
    btnSearchEl?.addEventListener('click', (e)=>{
      if (!nameField?.value?.trim()){
        e.preventDefault();
        alert('請輸入名稱再查詢');
        return;
      }
      Array.from(formCS.elements).forEach(el=>{
        if(['INPUT','SELECT'].includes(el.tagName) && !el.value){
          if(el.name) el.disabled = true;
        }
      });
      // 確保查詢不走 check-exists 邏輯
      formCS.submit();
    });

    /* ====== AI 填寫 (不變) ====== */
    const btnAiSuggest = document.getElementById('btnAiSuggest');
    function showGreenToast(msg){
      const t = document.createElement('div');
      t.className = 'toast'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 2300);
    }
    function applyLocationToUI(loc){
      const locHidden = document.getElementById('locationField-create');
      const locSelect = document.getElementById('locationSelect-create');
      const locInput  = document.getElementById('locationInput-create');
      if (!loc) return;
      if (locHidden) locHidden.value = loc;
      if (locSelect) {
        const hasOption = Array.from(locSelect.options).some(o => o.value === loc);
        if (hasOption) {
          locSelect.value = loc;
          if (locInput) locInput.style.display = 'none';
        } else {
          locSelect.value = '__NEW__';
          if (locInput) { locInput.style.display = ''; locInput.value = loc; }
        }
      }
    }
    async function aiFill() {
      const skuEl = document.getElementById('skuField') || document.querySelector('[name="sku"]');
      const name = (nameField?.value || '').trim();
      if (!name) { alert('請先輸入名稱再使用自動填寫'); return; }
      let res;
      try{
        res = await fetch('/ai/suggest', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
      }catch(e){ alert('自動填寫連線失敗：' + e.message); return; }
      if(!res.ok){ const text = await res.text(); alert('服務錯誤：' + text); return; }
      const data = await res.json();
      if (data.sku && skuEl) skuEl.value = data.sku;
      if (data.location) applyLocationToUI(data.location);
      if (data.category) {
        const catHidden = document.getElementById('categoryField-create');
        const catSelect = document.getElementById('categorySelect-create');
        const catInput  = document.getElementById('categoryInput-create');
        if (catHidden) catHidden.value = data.category;
        if (catSelect) {
            const hasOption = Array.from(catSelect.options).some(o => o.value === data.category);
            if (hasOption) {
            catSelect.value = data.category;
            if (catInput) catInput.style.display = 'none';
            } else {
            catSelect.value = '__NEW__';
            if (catInput) { catInput.style.display = ''; catInput.value = data.category; }
            }
        }
        showGreenToast(`建議類別：${data.category}`);
      }
      const msg = `已填寫：SKU=${data.sku || '-'} / 儲位=${data.location || '-'}` + (data.reason ? `（${data.reason}）` : '');
      showGreenToast(msg);
    }
    btnAiSuggest?.addEventListener('click', ()=> aiFill());

    /* ====== 行事曆 (不變) ====== */
    const calTitle = document.getElementById('calTitle');
    const calGrid = document.getElementById('calendarGrid');
    const calPrev = document.getElementById('calPrev');
    const calNext = document.getElementById('calNext');
    let calYear, calMonth;
    const today = new Date();
    function renderCalendar(){
      const firstDay = new Date(calYear, calMonth, 1);
      const firstWeekday = firstDay.getDay();
      const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
      if (calTitle) calTitle.textContent = calYear + ' / ' + (calMonth+1).toString().padStart(2,'0');
      if (!calGrid) return;
      calGrid.innerHTML = '';
      const weekdays = ['日','一','二','三','四','五','六'];
      weekdays.forEach(w=>{
        const cell = document.createElement('div');
        cell.className = 'calendar-cell cal-weekday'; cell.textContent = w; calGrid.appendChild(cell);
      });
      for(let i=0;i<firstWeekday;i++){
        const cell = document.createElement('div'); cell.className = 'calendar-cell'; calGrid.appendChild(cell);
      }
      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div'); cell.className = 'calendar-cell cal-day';
        const isToday = (calYear === today.getFullYear() && calMonth === today.getMonth() && d === today.getDate());
        if (isToday) cell.classList.add('today');
        cell.textContent = d; calGrid.appendChild(cell);
      }
    }
    if (calTitle && calGrid){
      calYear = today.getFullYear(); calMonth = today.getMonth(); renderCalendar();
      calPrev?.addEventListener('click', ()=>{ calMonth--; if (calMonth<0){ calMonth=11; calYear--; } renderCalendar(); });
      calNext?.addEventListener('click', ()=>{ calMonth++; if (calMonth>11){ calMonth=0; calYear++; } renderCalendar(); });
    }

    /* ====== 更改大數量：小視窗 (不變) ====== */
    const qtyModalBg = document.getElementById('qtyModalBg');
    const qtyInput = document.getElementById('qtyInput');
    const qtyCancel = document.getElementById('qtyCancel');
    const qtyOk = document.getElementById('qtyOk');
    let editingItemId = null;
    function openQtyModal(id, current){
      editingItemId = id; if (qtyInput) qtyInput.value = current;
      qtyModalBg?.classList.add('show'); qtyInput?.focus(); qtyInput?.select();
    }
    function closeQtyModal(){ qtyModalBg?.classList.remove('show'); editingItemId = null; }
    document.addEventListener('click',(e)=>{
      const btn = e.target.closest('.btn-editQty');
      if(btn){
        const id = btn.getAttribute('data-id'); const current = btn.getAttribute('data-current') || '0'; openQtyModal(id, current);
      }
    });
    qtyCancel?.addEventListener('click', closeQtyModal);
    qtyModalBg?.addEventListener('click',(e)=>{ if(e.target === qtyModalBg) closeQtyModal(); });
    qtyOk?.addEventListener('click', ()=>{
      const v = parseInt(qtyInput?.value ?? '0',10);
      if(isNaN(v) || v<0){ alert('請輸入大於等於 0 的數字'); return; }
      if(!editingItemId){ closeQtyModal(); return; }
      const form = document.createElement('form'); form.method = 'post';
      form.action = '/items/' + encodeURIComponent(editingItemId) + '/setQuantity';
      const input = document.createElement('input'); input.type = 'hidden'; input.name = 'quantity'; input.value = v;
      form.appendChild(input); document.body.appendChild(form); form.submit();
    });
    document.addEventListener('keydown',(e)=>{ if(e.key === 'Escape') closeQtyModal(); });
  </script>
</body>
</html>